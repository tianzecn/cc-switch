# 资源更新检测与安装功能规格说明

> **状态**: 待实现
> **创建日期**: 2026-01-07
> **访谈结果汇总**

## 1. 功能概述

为 CC Switch 的已安装资源（Skills、Commands、Hooks、Agents）提供更新检测和自动更新功能，让用户能够：

1. 检测已安装资源是否有远程更新
2. 查看更新详情（commit 信息、更新时间）
3. 一键更新单个或全部资源
4. 在发现模式中直接更新已安装资源

## 2. 核心决策总结

| 决策项 | 选择 | 说明 |
|--------|------|------|
| 触发时机 | 用户手动触发 | 点击"检查更新"按钮时才检测 |
| 检测方式 | blob SHA 比较 | 单文件级别精确检测 |
| API 认证 | 可选 GitHub Token | 默认未认证，可配置 PAT 提升配额 |
| 冲突处理 | 默认覆盖为远程版本 | 不备份，直接更新 |
| 更新粒度 | 任一文件变化即触发 | 目录内任何文件的 blob SHA 变化 |
| 并发控制 | 最多 5 个并发 | 平衡速度与 API 压力 |
| 缓存策略 | 不缓存 | 每次实时查询最新状态 |

## 3. 技术架构

### 3.1 数据模型变更

在现有已安装资源表中添加版本追踪字段：

```sql
-- 为 installed_skills 表添加
ALTER TABLE installed_skills ADD COLUMN installed_blob_sha TEXT;
ALTER TABLE installed_skills ADD COLUMN installed_at TIMESTAMP;

-- 为 installed_commands 表添加
ALTER TABLE installed_commands ADD COLUMN installed_blob_sha TEXT;
ALTER TABLE installed_commands ADD COLUMN installed_at TIMESTAMP;

-- 为 installed_hooks 表添加
ALTER TABLE installed_hooks ADD COLUMN installed_blob_sha TEXT;
ALTER TABLE installed_hooks ADD COLUMN installed_at TIMESTAMP;

-- 为 installed_agents 表添加
ALTER TABLE installed_agents ADD COLUMN installed_blob_sha TEXT;
ALTER TABLE installed_agents ADD COLUMN installed_at TIMESTAMP;
```

**字段说明：**
- `installed_blob_sha`: 安装时的文件 blob SHA（多文件资源存储主文件或 tree SHA）
- `installed_at`: 安装/更新时间戳

### 3.2 GitHub Token 配置

在设置中添加可选的 GitHub Personal Access Token 配置：

```sql
-- 在 settings 表中存储（加密或使用系统钥匙串）
-- key: 'github_pat'
-- value: 用户配置的 PAT
```

**API 配额：**
- 未认证：60 次/小时
- 认证后：5000 次/小时

### 3.3 更新检测流程

```
┌─────────────────────────────────────────────────────────────┐
│                    用户点击"检查更新"                         │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│              获取当前 Tab 的所有已安装资源                    │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│           按仓库分组，最多 5 个并发检查                       │
│                                                             │
│  对于每个资源：                                              │
│  1. 调用 GitHub API 获取文件的最新 blob SHA                  │
│     GET /repos/{owner}/{repo}/contents/{path}?ref={branch}  │
│  2. 比较本地 installed_blob_sha 与远程 SHA                   │
│  3. 如果不同，标记为有更新                                   │
│  4. 获取最新 commit 信息用于展示                             │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│              更新 UI 状态，展示检查结果                       │
└─────────────────────────────────────────────────────────────┘
```

### 3.4 分支回退机制

当记录的分支不存在时（如 master → main 迁移）：

```rust
async fn get_latest_sha(repo: &RepoInfo, path: &str) -> Result<String> {
    // 1. 尝试记录的分支
    match fetch_blob_sha(&repo.owner, &repo.name, &repo.branch, path).await {
        Ok(sha) => return Ok(sha),
        Err(e) if is_branch_not_found(&e) => {
            // 2. 回退到仓库默认分支
            let default_branch = get_repo_default_branch(&repo.owner, &repo.name).await?;
            return fetch_blob_sha(&repo.owner, &repo.name, &default_branch, path).await;
        }
        Err(e) => return Err(e),
    }
}
```

## 4. UI/UX 设计

### 4.1 入口位置

每个 Tab（Skills/Commands/Hooks/Agents）页面顶部工具栏添加"检查更新"按钮：

```
┌─────────────────────────────────────────────────────────────┐
│  Skills                          [检查更新] [+ 添加仓库]     │
├─────────────────────────────────────────────────────────────┤
│  已安装 │ 发现                                               │
├─────────────────────────────────────────────────────────────┤
```

### 4.2 检查进度展示

显示详细进度条：

```
┌─────────────────────────────────────────────────────────────┐
│  正在检查更新...                                             │
│  ████████████░░░░░░░░  12/20 个仓库                         │
│                                                             │
│  ✓ anthropics/skills (无更新)                               │
│  ✓ user/my-skills (2 个更新)                                │
│  ⟳ checking org/repo...                                     │
│  ✗ private/repo (访问失败)                                  │
└─────────────────────────────────────────────────────────────┘
```

### 4.3 更新状态展示

#### 4.3.1 顶部通知栏

检查完成后在页面顶部显示概览：

```
┌─────────────────────────────────────────────────────────────┐
│  🔄 发现 5 个可更新项目                    [全部更新] [忽略] │
└─────────────────────────────────────────────────────────────┘
```

#### 4.3.2 列表项 Badge

在每个有更新的已安装项目旁显示标记：

```
┌─────────────────────────────────────────────────────────────┐
│  📦 my-skill                                    🔄 有更新    │
│  A useful skill for...                                      │
│  ├─ 更新于 2 天前                                           │
│  └─ "fix: resolve edge case in parser"                     │
│                                              [更新] [查看]   │
├─────────────────────────────────────────────────────────────┤
│  📦 another-skill                              ✓ 最新        │
│  Another useful skill                                       │
│                                              [卸载] [查看]   │
└─────────────────────────────────────────────────────────────┘
```

#### 4.3.3 发现模式中的展示

对于已安装且有更新的资源，显示"已安装 - 有更新"状态，安装按钮变为"更新"：

```
┌─────────────────────────────────────────────────────────────┐
│  📦 remote-skill                        已安装 - 有更新 🔄   │
│  A remote skill from repo                                   │
│                                                    [更新]    │
└─────────────────────────────────────────────────────────────┘
```

### 4.4 更新信息展示

展示以下信息帮助用户决策：
- 更新状态标记
- 最新 commit 消息摘要
- 更新时间（"更新于 X 天前"）

### 4.5 完成通知

使用页面内 Toast 提示：

```
┌─────────────────────────────────────────┐
│  ✓ 检查完成：发现 3 个可更新项目         │
└─────────────────────────────────────────┘
```

## 5. 错误处理

### 5.1 网络异常处理

检查过程中遇到的错误：
1. **实时状态显示**：每个资源旁显示检查状态（成功/失败）
2. **汇总报告**：完成后统一报告哪些仓库检查失败

```
检查结果：
- 成功检查：18 个仓库
- 检查失败：2 个仓库
  - private/repo: 403 Forbidden
  - deleted/repo: 404 Not Found
```

### 5.2 远程资源已删除

当远程仓库中已安装的资源被删除时：
- 在列表中标记为"远程已删除"
- 显示建议："此资源在远程仓库中已不存在，建议卸载本地副本"
- 提供一键卸载按钮

### 5.3 批量更新失败处理

策略：**部分成功，继续其他**
- 失败的跳过，成功的保留
- 最后报告失败列表：

```
更新完成：
- 成功：8 个
- 失败：2 个
  - my-skill: 网络超时
  - broken-skill: 文件解析错误
```

## 6. 更新执行流程

### 6.1 单个资源更新

```
用户点击 [更新]
    │
    ▼
下载最新版本（从 GitHub zip）
    │
    ▼
同时更新：
├── SSOT 目录 (~/.cc-switch/ssot/...)
└── 应用目录 (~/.claude/..., ~/.codex/..., ~/.gemini/...)
    │
    ▼
更新数据库记录：
├── 更新 installed_blob_sha
└── 更新 installed_at
    │
    ▼
刷新 UI 显示
```

### 6.2 批量更新

"全部更新"按钮行为：
1. 并发更新所有标记为"有更新"的资源
2. 最多 5 个并发
3. 每个完成后立即刷新其 UI 状态
4. 失败的跳过，继续处理其他
5. 完成后显示汇总报告

## 7. 设置页面

在设置中添加：

### 7.1 GitHub Token 配置

```
┌─────────────────────────────────────────────────────────────┐
│  GitHub 集成                                                │
├─────────────────────────────────────────────────────────────┤
│  Personal Access Token (可选)                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ ghp_xxxx...                                    [显示] │   │
│  └─────────────────────────────────────────────────────┘   │
│  配置后可获得更高的 API 请求配额 (5000次/小时)               │
│  [验证 Token]                                               │
│                                                             │
│  当前状态：✓ 已认证 (剩余配额: 4832/5000)                   │
└─────────────────────────────────────────────────────────────┘
```

### 7.2 Token 所需权限

最小权限要求：
- `repo` scope (用于访问公开和私有仓库内容)
- 或者只需 `public_repo` 如果只使用公开仓库

## 8. API 使用

### 8.1 主要 API 端点

```
# 获取文件内容和 SHA
GET /repos/{owner}/{repo}/contents/{path}?ref={branch}
Response: { sha: "blob_sha", ... }

# 获取 commit 信息
GET /repos/{owner}/{repo}/commits/{branch}
Response: { sha: "...", commit: { message: "...", author: { date: "..." } } }

# 获取仓库默认分支
GET /repos/{owner}/{repo}
Response: { default_branch: "main", ... }
```

### 8.2 请求头

```
Authorization: Bearer {github_pat}  // 如果配置了 Token
Accept: application/vnd.github.v3+json
User-Agent: CC-Switch/1.0
```

## 9. 实现优先级

### Phase 1：基础框架
1. 数据库 schema 变更
2. GitHub API 封装
3. 基础检查更新逻辑

### Phase 2：UI 实现
1. 检查更新按钮和进度展示
2. 列表项状态 Badge
3. 顶部通知栏

### Phase 3：更新执行
1. 单个资源更新
2. 批量更新
3. 发现模式中的更新入口

### Phase 4：设置与优化
1. GitHub Token 配置页面
2. 错误处理完善
3. 性能优化

## 10. 边界情况清单

| 场景 | 处理方式 |
|------|---------|
| 分支被删除/重命名 | 回退到仓库默认分支 |
| 仓库被删除 | 标记为"源仓库不可访问" |
| 仓库变为私有 | 提示配置 Token 或标记为不可访问 |
| API 配额耗尽 | 显示友好提示，建议配置 Token |
| 本地文件被修改 | 直接覆盖（无备份） |
| 网络超时 | 单个超时跳过，继续检查其他 |
| 多文件资源部分更新失败 | 整个资源标记为更新失败 |

## 11. 测试要点

### 11.1 单元测试
- blob SHA 比较逻辑
- 分支回退逻辑
- 更新状态判断

### 11.2 集成测试
- 完整的检查-更新流程
- 并发控制
- 错误恢复

### 11.3 E2E 测试
- UI 交互流程
- 进度展示
- Toast 通知

---

## 附录：访谈决策记录

| 问题 | 用户选择 |
|------|---------|
| 触发时机 | 用户手动触发 |
| API 认证策略 | 可选配置 GitHub Token |
| 更新展示方式 | 两者结合（顶部通知栏 + 列表项 Badge） |
| 本地修改冲突处理 | 默认覆盖为远程版本 |
| 检测技术方案 | 比较 commit SHA（blob SHA 级别） |
| SHA 粒度 | 单文件级别 |
| 远程删除处理 | 通知用户并建议卸载 |
| UI 入口位置 | 每个 Tab 页面顶部工具栏 |
| 同步策略 | 直接更新所有位置 |
| 备份策略 | 不备份 |
| 批量失败处理 | 部分成功，继续其他 |
| 发现模式展示 | 显示"已安装 - 有更新"，按钮变为"更新" |
| 网络异常处理 | 实时状态 + 汇总报告 |
| 结果缓存 | 不缓存，每次实时查询 |
| 更新信息展示 | 状态 + commit 消息 + 更新时间 |
| SHA 存储位置 | 在现有记录表中加字段 |
| 并发控制 | 限制并发数（5个） |
| 进度展示 | 详细进度条 |
| 分支变化处理 | 检测失败时尝试默认分支 |
| 多文件更新定义 | 任一文件变化即为有更新 |
| 完成通知 | 页面内 Toast 提示 |
