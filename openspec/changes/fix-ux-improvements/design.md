# 技术设计文档

## Context

本变更涉及多个系统模块的改进，包括 UI 组件、数据库结构和后端服务。需要引入新的前端依赖，并对现有数据结构进行扩展。

### Stakeholders
- 用户：期望更好的体验和更完整的功能
- 开发者：需要维护代码质量和一致性

### Constraints
- 必须保持与现有数据的兼容性
- 数据库迁移必须支持无损升级
- UI 风格必须与 shadcn/ui 保持一致

## Goals / Non-Goals

### Goals
- 修复所有已知 Bug
- 提供一致的手风琴导航体验
- 实现高性能的虚拟滚动列表
- 完善资源详情展示
- 建立更新追踪机制

### Non-Goals
- 不实现自动更新检测（仍需用户手动触发）
- 不修改 GitHub API 调用方式
- 不重构整体页面布局

## Decisions

### 1. 虚拟滚动库选型

**决定**：使用 `@tanstack/react-virtual`

**原因**：
- 与项目已使用的 TanStack Query 属于同一生态，API 风格一致
- 轻量级，无额外依赖
- 支持动态高度、水平/垂直滚动

**备选方案**：
- `react-window`：更成熟但 API 较旧
- 原生实现：开发成本高，容易出 bug

### 2. 更新历史存储策略

**决定**：本地 SQLite 记录，保留最近 20 条

**原因**：
- 无需依赖外部 API
- 避免 GitHub API 配额问题
- 20 条足够追溯，不会占用过多存储

**备选方案**：
- GitHub API 实时获取：受 API 配额限制
- 永久保留：存储占用随时间增长

### 3. 时间显示格式

**决定**：使用绝对时间格式 `YYYY-MM-DD HH:mm`

**原因**：
- 用户明确表示偏好绝对时间
- 跨时区场景下更准确

### 4. 手风琴导航状态管理

**决定**：创建独立的 `useTreeNavigation` hook

**原因**：
- 四个页面共享相同逻辑
- 易于测试和维护
- 状态集中管理

### 5. 骨架屏设计

**决定**：模拟列表项形状的骨架屏

**原因**：
- 用户体验更流畅
- 与 shadcn/ui 风格一致

## Risks / Trade-offs

| 风险 | 缓解措施 |
|------|----------|
| 虚拟滚动与复杂列表项交互 | 充分测试各种列表项类型 |
| 数据库迁移失败 | 迁移前自动备份，支持回滚 |
| 新依赖包体积影响 | react-virtual 仅 ~3KB gzipped |
| 手风琴模式与现有交互冲突 | 统一四个页面的导航逻辑 |

## Migration Plan

### 数据库迁移

1. **检测版本**：启动时检查是否存在新字段
2. **备份数据库**：迁移前自动创建备份
3. **执行迁移**：使用 `ALTER TABLE ... ADD COLUMN` 添加字段
4. **验证完整性**：迁移后检查数据一致性

### 回滚策略

- 新字段使用 `DEFAULT` 值，不影响旧版本读取
- 备份文件保留 7 天

## Open Questions

1. ~~骨架屏样式细节~~ → 已确认：模拟列表项形状
2. ~~更新历史保留数量~~ → 已确认：20 次
3. ~~时间格式~~ → 已确认：绝对时间
